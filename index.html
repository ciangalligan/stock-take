<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Take Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --main-bg:#FFF1E0;--chart-bg:#FFF1E0;
  --line1:#1a2e4b;--line2:#e07b62;
  --area-color:#c1d3e0;--font-color:#333;
  --btn-bg:#e0e0e0;
}
body{font-family:'League Spartan',sans-serif;background:var(--main-bg);margin:0;padding:20px;display:flex;flex-direction:column;align-items:center;}
h1{font-weight:600;margin:0;color:var(--font-color);text-align:center;}
h2{font-style:italic;font-weight:400;font-size:0.9rem;color:var(--font-color);margin:10px 0 10px;text-align:center;}
section{width:95%;max-width:1600px;background:var(--chart-bg);border-radius:10px;padding:20px;margin-bottom:30px;display:flex;flex-direction:column;align-items:center;}
#stock-heading{font-size:1.5rem;font-weight:600;margin-bottom:10px;}
#input-area{margin:5px 0;width:250px;position:relative;}
input[type=text]{padding:8px 12px;font-size:16px;border:1px solid #ccc;border-radius:5px;width:100%;}
#suggestions{position:absolute;background:#fff;width:100%;border:1px solid #ccc;max-height:250px;overflow-y:auto;z-index:10;display:none;}
#suggestions div{padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:8px;}
#suggestions div:hover{background-color:var(--area-color);}
#suggestions img{width:16px;height:16px;}
#stock-info{display:flex;gap:15px;margin:10px 0;justify-content:center;flex-wrap:wrap;}
.stock-item{background:var(--btn-bg);padding:10px 15px;border-radius:6px;border:1px solid #ccc;}
#range-buttons{margin:15px 0;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.range-btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;background:var(--btn-bg);color:var(--font-color);font-weight:600;}
.range-btn.active{background:var(--line1);color:#fff;}
#chart{width:55%;height:450px;background:var(--chart-bg);position:relative;}
#chart-logo{position:absolute;top:20%;left:20%;transform:translate(-50%, -50%);opacity:0.4;width:70px;height:70px;pointer-events:none;z-index:0;filter:grayscale(100%) brightness(0) invert(1);display:none;}
.loading{color:var(--line1);font-weight:600;margin:20px 0;}
canvas{display:block;width:100%;height:100%;position:relative;z-index:1;}
.trend-arrow{font-size:1.3rem;margin-left:10px;display:inline-flex;align-items:center;}
.trend-arrow .arrow{font-weight:400;color:#333;}
#debug{margin-top:20px;padding:15px;background:#f5f5f5;border-radius:6px;max-width:800px;font-size:12px;font-family:monospace;white-space:pre-wrap;max-height:200px;overflow-y:auto;display:none;}
.api-note{font-size:0.85rem;color:#666;margin-top:10px;text-align:center;font-style:italic;}
.api-selector{margin:10px 0;}
.api-selector select{padding:6px 12px;border-radius:4px;border:1px solid #ccc;font-family:'League Spartan',sans-serif;}
#stock-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:15px;}
#stock-name{font-size:1.1rem;color:#666;}
#search-controls {
    display: flex;
    gap: 30px; /* Increased gap */
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}
</style>
</head>
<body>

<h1>Stock Take</h1>
<h2>Finance Through Data</h2>

<section id="stocks-section">
  <div id="search-controls">
    <div id="input-area">
      <input type="text" id="ticker" placeholder="Search ticker (e.g. AAPL)">
      <div id="suggestions"></div>
    </div>
    
    <label style="white-space:nowrap;"><input type="checkbox" id="overlay-ticker"> Overlay Second Ticker</label>
  </div>
  
  <div id="stock-info">
    <div class="stock-item" id="info-close">Close: -</div>
    <div class="stock-item" id="info-open">Open: -</div>
    <div class="stock-item" id="info-volume">Volume: -</div>
  </div>
  
  <div id="range-buttons">
    <button class="range-btn" data-range="30">1M</button>
    <button class="range-btn" data-range="90">3M</button>
    <button class="range-btn active" data-range="180">6M</button>
    <button class="range-btn" data-range="365">1Y</button>
  </div>
  
  <div id="stock-header">
    <span id="stock-name">Apple Inc.</span>
    <span id="stock-heading">AAPL</span>
    <span class="trend-arrow" id="trend-arrow" style="display:none;">
      <span class="arrow" id="arrow-icon"></span>
    </span>
  </div>
  
  <div id="loading" class="loading" style="display:none;">Loading data...</div>
  <div id="chart">
    <img id="chart-logo" src="" alt="">
    <canvas id="chartCanvas"></canvas>
  </div>
  
  <div class="api-selector" style="margin-top:15px;">
    <label>API Provider: 
      <select id="api-select">
        <option value="finnhub">Finnhub (Free)</option>
        <option value="alphavantage">Alpha Vantage (Demo)</option>
        <option value="twelvedata">Twelve Data (Free)</option>
      </select>
    </label>
    <button id="debug-toggle" style="margin-left:10px;padding:6px 12px;border-radius:4px;border:1px solid #ccc;cursor:pointer;">Show Debug</button>
  </div>
  <div class="api-note" id="api-note">Using Finnhub API</div>
  
  <div id="debug"></div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
const tickerInput = document.getElementById("ticker");
const suggestionsDiv = document.getElementById("suggestions");
const overlayCheckbox = document.getElementById("overlay-ticker");
const stockHeading = document.getElementById("stock-heading");
const stockName = document.getElementById("stock-name");
const chartLogo = document.getElementById("chart-logo");
const loadingDiv = document.getElementById("loading");
const debugDiv = document.getElementById("debug");
const debugToggle = document.getElementById("debug-toggle");
const apiSelect = document.getElementById("api-select");
const apiNote = document.getElementById("api-note");
const trendArrow = document.getElementById("trend-arrow");
const arrowIcon = document.getElementById("arrow-icon");

const stockInfo = {
  close: document.getElementById("info-close"),
  open: document.getElementById("info-open"),
  volume: document.getElementById("info-volume")
};
const rangeButtons = document.querySelectorAll(".range-btn");
const canvas = document.getElementById("chartCanvas");
const ctx = canvas.getContext("2d");

let data = [];
let overlayData = [];
let overlaySymbol = "";
let chart = null;
let debugLog = [];

const APIs = {
  finnhub: {
    name: "Finnhub",
    key: "ct7bu69r01qioqnedut0ct7bu69r01qioqneduug",
    note: "Free tier - 60 calls/minute"
  },
  alphavantage: {
    name: "Alpha Vantage",
    key: "demo",
    note: "Demo key - works for IBM, limited calls"
  },
  twelvedata: {
    name: "Twelve Data",
    key: "2559df918c6e4e2dbe04f56d151feca5",
    note: "Demo key - 8 calls/day"
  }
};

// Full list of S&P 500 Tickers (503 entries) + ETFs
const tickersList = [
    "MMM", "ABT", "ABBV", "ACN", "ATVI", "ADBE", "AEP", "AFL", "A", "APD",
    "AKAM", "ALK", "ALB", "ARE", "ALXN", "ALGN", "ALLE", "LNT", "ALL", "GOOGL",
    "GOOG", "AMZN", "AEE", "AAL", "AEP", "AXP", "AIG", "AMT", "AMP", "ABC",
    "AME", "AMGN", "APH", "ADI", "ANSS", "ANTM", "AON", "APA", "AIV", "T",
    "APTV", "BKR", "AAP", "AAPL", "AMAT", "APO", "ADM", "ABMD", "ANET", "AJG",
    "AIZ", "TGT", "TSN", "TPR", "TFC", "TDY", "TDG", "TECH", "TEL", "FTI",
    "TXN", "TXT", "TMO", "TIF", "TWTR", "TJX", "TMUS", "TSS", "TRV", "TRMB",
    "TWO", "TSLA", "TTWO", "UAA", "UAL", "UHS", "UL", "UNP", "UNH", "URI",
    "UDR", "ULTA", "USB", "UTX", "V", "VAR", "VTR", "VFC", "VIAC", "VLO",
    "VRSN", "VRSK", "VRTX", "VNO", "VMC", "WAB", "WBA", "WDC", "WM", "WLTW",
    "WYNN", "XEL", "XLNX", "XOM", "XYL", "YUM", "ZBH", "ZION", "ZTS", "ALLE",
    "HAS", "BAX", "BDX", "BBY", "BIIB", "BBT", "BK", "BA", "BWA", "BXP",
    "BSX", "BHF", "BMY", "BF.B", "CPB", "COF", "CA", "KMX", "CCL", "CDNS",
    "CZR", "CPRI", "CBRE", "CCI", "CHTR", "CVX", "CMG", "CB", "CHD", "CI",
    "CINF", "C", "CFG", "CLX", "CME", "CMS", "KO", "CTSH", "CL", "CMA",
    "CAG", "COP", "ED", "STZ", "COO", "CPRT", "CSX", "CTVA", "COST", "CRM",
    "CSCO", "CVS", "DHR", "DRI", "DE", "DAL", "DTE", "DVA", "DISCA", "DISCK",
    "DISH", "DG", "DLTR", "D", "DOV", "DOW", "DTE", "DUK", "DRE", "DD",
    "DXC", "EIX", "EMR", "ETR", "EOG", "ECL", "EFX", "EA", "EMN", "ETN",
    "EW", "EVRG", "ES", "EXC", "EXPE", "EXPD", "FB", "FFIV", "FTV", "FBHS",
    "FAST", "FRC", "FE", "FIS", "FISV", "FLT", "FMC", "F", "BEN", "FCX",
    "GPS", "GM", "GPC", "GILD", "GL", "GPN", "GS", "GWW", "HOG", "HIG",
    "HES", "HPQ", "HUM", "HBAN", "HBI", "IDXX", "IEX", "IR", "IT", "ICE",
    "ILMN", "INCY", "INTU", "ISRG", "IVZ", "IPG", "IP", "IRM", "JNJ", "JCI",
    "JEF", "K", "KEY", "KLAC", "KSU", "KR", "LB", "LDOS", "LEN", "LUK",
    "LNC", "LIN", "LOW", "LYB", "MTD", "M", "MAC", "MAR", "MCK", "MDT",
    "MRK", "MET", "MIXT", "MSI", "MCHP", "MKC", "MMC", "MLM", "MDLZ", "MNST",
    "MCO", "MOS", "MS", "MSCI", "NDAQ", "NOV", "NSC", "NUE", "NFLX", "NWS",
    "NWSA", "NCLH", "NKTR", "NRG", "NTR", "NTAP", "NTRS", "NVR", "NVDA", "ORLY",
    "OXY", "OMC", "ONEOK", "ORCL", "ODFL", "PCAR", "PKG", "PAYX", "PEAK", "PCG",
    "PEP", "PRGO", "PFE", "PM", "PSX", "PNW", "PPL", "PGR", "PLD", "PNC",
    "PPG", "PPR", "PQG", "PRU", "PVH", "QCOM", "QSR", "QRVO", "RCL", "RSG",
    "RHT", "RHI", "RNG", "ROK", "ROST", "RCL", "RTN", "SPGI", "SIVB", "SNA",
    "SO", "SPG", "SJM", "SRE", "SSTI", "STE", "SWKS", "SYF", "SYK", "SYY",
    "TAP", "TDY", "TEL", "TIF", "TJX", "TMO", "TRV", "TSCO", "TSN", "TWTR",
    "TXN", "TXT", "UAL", "UDR", "UHS", "ULTA", "UNM", "UNP", "UPS", "URI",
    "V", "VAR", "VFC", "VIAC", "VNO", "VRSK", "VRTX", "VZ", "WAB", "WAT",
    "WBA", "WDC", "WM", "WMB", "WLTW", "WHR", "WYNN", "XEL", "XLNX", "XOM",
    "ZBH", "ZTS", "AVGO", "CARR", "DXCM", "FB", "FTNT", "HPE", "KSS", "LUMN",
    "MCD", "MMM", "MSFT", "NEM", "O", "PAGP", "PDD", "PPG", "QRVO", "RSG",
    "STX", "TROW", "TTWO", "WST", "ZBRA", "ZTS", "SPY", "QQQ", "DIA" // Added ETFs
];

// Names for the full S&P 500 list (including some not in the list above but historically relevant)
const stockNames = {
    "MMM": "3M Company", "ABT": "Abbott Laboratories", "ABBV": "AbbVie Inc.", "ACN": "Accenture plc",
    "ATVI": "Activision Blizzard", "ADBE": "Adobe Inc.", "AEP": "American Electric Power Company", "AFL": "Aflac Inc.",
    "A": "Agilent Technologies Inc", "APD": "Air Products & Chemicals Inc", "AKAM": "Akamai Technologies Inc",
    "ALK": "Alaska Air Group Inc", "ALB": "Albemarle Corp", "ARE": "Alexandria Real Estate Equities Inc",
    "ALXN": "Alexion Pharmaceuticals", "ALGN": "Align Technology", "ALLE": "Allegion PLC", "LNT": "Alliant Energy Corp",
    "ALL": "Allstate Corp", "GOOGL": "Alphabet Inc. (Class A)", "GOOG": "Alphabet Inc. (Class C)",
    "AMZN": "Amazon.com, Inc.", "AEE": "Ameren Corp", "AAL": "American Airlines Group", "AXP": "American Express Co",
    "AIG": "American International Group", "AMT": "American Tower Corp", "AMP": "AMERIPRISE FINANCIAL SERVICES INC",
    "ABC": "AmerisourceBergen Corp", "AME": "AMETEK Inc", "AMGN": "Amgen Inc.", "APH": "Amphenol Corp",
    "ADI": "Analog Devices, Inc.", "ANSS": "ANSYS Inc", "ANTM": "Anthem Inc.", "APA": "APA Corporation",
    "AIV": "Apartment Investment & Management", "T": "AT&T Inc.", "APTV": "Aptiv PLC", "BKR": "Baker Hughes Co",
    "AAP": "Advance Auto Parts", "AAPL": "Apple Inc.", "AMAT": "Applied Materials Inc", "APO": "Apollo Global Management",
    "ADM": "Archer-Daniels-Midland Co", "ABMD": "Abiomed", "ANET": "Arista Networks", "AJG": "Arthur J. Gallagher & Co.",
    "AIZ": "Assurant Inc", "TGT": "Target Corp.", "TSN": "Tyson Foods Inc", "TPR": "Tapestry, Inc.",
    "TFC": "Truist Financial Corp", "TDY": "Teledyne Technologies", "TDG": "TransDigm Group", "TECH": "Tech Data Corp",
    "TEL": "TE Connectivity Ltd", "FTI": "TechnipFMC", "TXN": "Texas Instruments Inc.", "TXT": "Textron Inc.",
    "TMO": "Thermo Fisher Scientific Inc", "TIF": "Tiffany & Co.", "TWTR": "Twitter, Inc.", "TJX": "TJX Companies Inc",
    "TMUS": "T-Mobile US Inc", "TSS": "Total System Services", "TRV": "The Travelers Companies Inc.", "TRMB": "Trimble Inc",
    "TWO": "Two Harbors Investment Corp", "TSLA": "Tesla, Inc.", "TTWO": "Take-Two Interactive", "UAA": "Under Armour (Class A)",
    "UAL": "United Airlines Holdings, Inc.", "UHS": "Universal Health Services, Inc.", "UL": "Unilever PLC",
    "UNP": "Union Pacific Corp", "UNH": "UnitedHealth Group Inc.", "URI": "United Rentals Inc", "UDR": "UDR Inc",
    "ULTA": "Ulta Beauty Inc", "USB": "U.S. Bancorp", "UTX": "United Technologies Corp", "V": "Visa Inc. (Class A)",
    "VAR": "Varian Medical Systems", "VTR": "Ventas Inc", "VFC": "VF Corp", "VIAC": "ViacomCBS Inc.",
    "VLO": "Valero Energy Corp", "VRSN": "VeriSign Inc", "VRSK": "Verisk Analytics", "VRTX": "Vertex Pharmaceuticals Inc",
    "VNO": "Vornado Realty Trust", "VMC": "Vulcan Materials Co", "WAB": "Westinghouse Air Brake Technologies",
    "WBA": "Walgreens Boots Alliance", "WDC": "Western Digital Corp", "WM": "Waste Management Inc.",
    "WLTW": "Willis Towers Watson", "WYNN": "Wynn Resorts Ltd", "XEL": "Xcel Energy Inc", "XLNX": "Xilinx, Inc.",
    "XOM": "Exxon Mobil Corp.", "XYL": "Xylem Inc.", "YUM": "Yum! Brands Inc", "ZBH": "Zimmer Biomet Holdings",
    "ZION": "Zions Bancorporation", "ZTS": "Zoetis", "HAS": "Hasbro Inc.", "BAX": "Baxter International",
    "BDX": "Becton Dickinson", "BBY": "Best Buy Co Inc", "BIIB": "Biogen Inc.", "BBT": "BB&T Corp",
    "BK": "The Bank of New York Mellon", "BA": "The Boeing Company", "BWA": "BorgWarner", "BXP": "Boston Properties",
    "BSX": "Boston Scientific", "BHF": "Brighthouse Financial Inc", "BMY": "Bristol-Myers Squibb",
    "BF.B": "Brown-Forman Corp. (Class B)", "CPB": "Campbell Soup Co", "COF": "Capital One Financial Corp",
    "CA": "CA, Inc.", "KMX": "CarMax Inc", "CCL": "Carnival Corp.", "CDNS": "Cadence Design Systems",
    "CZR": "Caesars Entertainment", "CPRI": "Capri Holdings", "CBRE": "CBRE Group", "CCI": "Crown Castle International",
    "CHTR": "Charter Communications", "CVX": "Chevron Corp", "CMG": "Chipotle Mexican Grill", "CB": "Chubb Limited",
    "CHD": "Church & Dwight Co", "CI": "Cigna Corp.", "CINF": "Cincinnati Financial", "C": "Citigroup Inc.",
    "CFG": "Citizens Financial Group", "CLX": "The Clorox Company", "CME": "CME Group Inc.", "CMS": "CMS Energy",
    "KO": "The Coca-Cola Company", "CTSH": "Cognizant Technology Solutions", "CL": "Colgate-Palmolive Co",
    "CMA": "Comerica Inc", "CAG": "Conagra Brands", "COP": "ConocoPhillips", "ED": "Consolidated Edison",
    "STZ": "Constellation Brands", "COO": "The Cooper Companies", "CPRT": "Copart Inc", "CSX": "CSX Corp",
    "CTVA": "Corteva, Inc.", "COST": "Costco Wholesale Corp", "CRM": "Salesforce.com Inc.", "CSCO": "Cisco Systems Inc",
    "CVS": "CVS Health Corp", "DHR": "Danaher Corp.", "DRI": "Darden Restaurants", "DE": "Deere & Co",
    "DAL": "Delta Air Lines Inc", "DTE": "DTE Energy Co", "DVA": "DaVita Inc.", "DISCA": "Discovery Inc. (Class A)",
    "DISCK": "Discovery Inc. (Class C)", "DISH": "DISH Network Corp", "DG": "Dollar General", "DLTR": "Dollar Tree Inc.",
    "D": "Dominion Energy", "DOV": "Dover Corp", "DOW": "Dow Inc.", "DUK": "Duke Energy Corp",
    "DRE": "Duke Realty Corp", "DD": "DuPont de Nemours Inc.", "DXC": "DXC Technology Co", "EIX": "Edison International",
    "EMR": "Emerson Electric Co", "ETR": "Entergy Corp", "EOG": "EOG Resources", "ECL": "Ecolab Inc.",
    "EFX": "Equifax Inc.", "EA": "Electronic Arts", "EMN": "Eastman Chemical Co", "ETN": "Eaton Corp plc",
    "EW": "Edwards Lifesciences", "EVRG": "Evergy Inc", "ES": "Eversource Energy", "EXC": "Exelon Corp",
    "EXPE": "Expedia Group", "EXPD": "Expeditors International", "FB": "Meta Platforms, Inc. (formerly Facebook)",
    "FFIV": "F5 Networks", "FTV": "Fortive Corp", "FBHS": "Fortune Brands Home & Security", "FAST": "Fastenal Co",
    "FRC": "First Republic Bank", "FE": "FirstEnergy Corp", "FIS": "Fidelity National Information Services",
    "FISV": "Fiserv Inc", "FLT": "FleetCor Technologies", "FMC": "FMC Corp", "F": "Ford Motor Company",
    "BEN": "Franklin Resources", "FCX": "Freeport-McMoRan", "GPS": "Gap Inc.", "GM": "General Motors",
    "GPC": "Genuine Parts Co", "GILD": "Gilead Sciences", "GL": "Globe Life Inc.", "GPN": "Global Payments Inc.",
    "GS": "Goldman Sachs Group", "GWW": "W.W. Grainger, Inc.", "HOG": "Harley-Davidson", "HIG": "The Hartford Financial Services Group",
    "HES": "Hess Corporation", "HPQ": "HP Inc.", "HUM": "Humana Inc.", "HBAN": "Huntington Bancshares Inc",
    "HBI": "Hanesbrands Inc.", "IDXX": "IDEXX Laboratories", "IEX": "IDEX Corporation", "IR": "Ingersoll Rand",
    "IT": "Gartner Inc", "ICE": "Intercontinental Exchange", "ILMN": "Illumina Inc", "INCY": "Incyte Corporation",
    "INTU": "Intuit Inc.", "ISRG": "Intuitive Surgical Inc.", "IVZ": "Invesco Ltd.", "IPG": "The Interpublic Group of Companies",
    "IP": "International Paper Co", "IRM": "Iron Mountain Inc", "JNJ": "Johnson & Johnson", "JCI": "Johnson Controls International",
    "JEF": "Jefferies Financial Group", "K": "Kellogg Co.", "KEY": "KeyCorp", "KLAC": "KLA Corporation",
    "KSU": "Kansas City Southern", "KR": "The Kroger Co", "LB": "L Brands Inc.", "LDOS": "Leidos Holdings",
    "LEN": "Lennar Corp. (Class A)", "LUK": "Leucadia National Corp.", "LNC": "Lincoln National Corp", "LIN": "Linde plc",
    "LOW": "Lowe's Companies Inc", "LYB": "LyondellBasell Industries", "MTD": "Mettler-Toledo International",
    "M": "Macy's Inc.", "MAC": "Macerich Co.", "MAR": "Marriott International", "MCK": "McKesson Corp",
    "MDT": "Medtronic plc", "MRK": "Merck & Co., Inc.", "MET": "MetLife Inc.", "MIXT": "MiX Telematics",
    "MSI": "Motorola Solutions Inc.", "MCHP": "Microchip Technology", "MKC": "McCormick & Company",
    "MMC": "Marsh & McLennan Companies", "MLM": "Martin Marietta Materials", "MDLZ": "Mondelez International",
    "MNST": "Monster Beverage Corp", "MCO": "Moody's Corp", "MOS": "The Mosaic Company", "MS": "Morgan Stanley",
    "MSCI": "MSCI Inc", "NDAQ": "Nasdaq, Inc.", "NOV": "NOV Inc.", "NSC": "Norfolk Southern Corp",
    "NUE": "Nucor Corp.", "NFLX": "Netflix, Inc.", "NWS": "News Corp. (Class B)", "NWSA": "News Corp. (Class A)",
    "NCLH": "Norwegian Cruise Line Holdings", "NKTR": "Nektar Therapeutics", "NRG": "NRG Energy", "NTR": "Nutrien Ltd",
    "NTAP": "NetApp Inc.", "NTRS": "Northern Trust Corp", "NVR": "NVR Inc", "NVDA": "NVIDIA Corp.",
    "ORLY": "O'Reilly Automotive", "OXY": "Occidental Petroleum Corp", "OMC": "Omnicom Group", "ONEOK": "ONEOK Inc.",
    "ORCL": "Oracle Corp.", "ODFL": "Old Dominion Freight Line", "PCAR": "PACCAR Inc", "PKG": "Packaging Corp of America",
    "PAYX": "Paychex Inc", "PEAK": "Healthpeak Properties", "PCG": "PG&E Corp.", "PEP": "PepsiCo, Inc.",
    "PRGO": "Perrigo Co PLC", "PFE": "Pfizer Inc.", "PM": "Philip Morris International", "PSX": "Phillips 66",
    "PNW": "Pinnacle West Capital Corp", "PPL": "PPL Corp", "PGR": "Progressive Corp.", "PLD": "Prologis Inc.",
    "PNC": "PNC Financial Services", "PPG": "PPG Industries", "PPR": "Pentair plc", "PQG": "PQ Group Holdings",
    "PRU": "Prudential Financial", "PVH": "PVH Corp.", "QCOM": "Qualcomm Inc.", "QSR": "Restaurant Brands International",
    "QRVO": "Qorvo Inc.", "RCL": "Royal Caribbean Group", "RSG": "Republic Services Inc", "RHT": "Red Hat Inc.",
    "RHI": "Robert Half International", "RNG": "RingCentral Inc.", "ROK": "Rockwell Automation Inc.",
    "ROST": "Ross Stores Inc", "RTN": "Raytheon Technologies", "SPGI": "S&P Global Inc", "SIVB": "SVB Financial Group",
    "SNA": "Snap-on Inc.", "SO": "The Southern Co", "SPG": "Simon Property Group Inc", "SJM": "The J. M. Smucker Company",
    "SRE": "Sempra Energy", "SSTI": "Stemline Therapeutics", "STE": "STERIS plc", "SWKS": "Skyworks Solutions",
    "SYF": "Synchrony Financial", "SYK": "Stryker Corp", "SYY": "Sysco Corp.", "TAP": "Molson Coors Beverage Co",
    "TSCO": "Tractor Supply Company", "UNM": "Unum Group", "UPS": "United Parcel Service Inc.", "WAB": "Wabtec Corporation",
    "WAT": "Waters Corp", "WMB": "Williams Companies Inc", "WHR": "Whirlpool Corp.", "SPY": "SPDR S&P 500 ETF",
    "QQQ": "Invesco QQQ Trust", "DIA": "SPDR Dow Jones Industrial Average ETF"
};


function log(msg, data) {
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = "[" + timestamp + "] " + msg;
  debugLog.push(logEntry);
  if(data) debugLog.push(JSON.stringify(data, null, 2));
  debugDiv.textContent = debugLog.slice(-20).join('\n');
  console.log(msg, data);
}

debugToggle.addEventListener("click", () => {
  if(debugDiv.style.display === "none") {
    debugDiv.style.display = "block";
    debugToggle.textContent = "Hide Debug";
  } else {
    debugDiv.style.display = "none";
    debugToggle.textContent = "Show Debug";
  }
});

apiSelect.addEventListener("change", () => {
  const api = APIs[apiSelect.value];
  apiNote.textContent = "Using " + api.name + " - " + api.note;
  log("Switched to " + api.name + " API");
});

tickerInput.addEventListener("input", () => {
  const val = tickerInput.value.trim().toUpperCase();
  const filtered = tickersList.filter(t => t.startsWith(val));
  suggestionsDiv.innerHTML = filtered.map(t => {
    // Attempting to use a simple icon for the ticker
    return `<div data-ticker="${t}"><img src="https://cdn.simpleicons.org/${t.toLowerCase()}" onerror="this.remove()" alt="">${t} - ${stockNames[t] || 'Unknown'}</div>`;
  }).join("");
  suggestionsDiv.style.display = filtered.length ? "block" : "none";
});

// New feature: Show list when input is focused/clicked
tickerInput.addEventListener("focus", () => {
    const val = tickerInput.value.trim().toUpperCase();
    const filtered = tickersList.filter(t => t.startsWith(val));
    if (filtered.length) {
        suggestionsDiv.style.display = "block";
    }
});

document.addEventListener("click", (e) => {
  if (!tickerInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
    suggestionsDiv.style.display = 'none';
  }
});

suggestionsDiv.addEventListener("click", (e) => {
  const div = e.target.closest("div");
  if(div) {
    // Extract only the ticker from the div's text content, which now includes the name
    const tickerText = div.textContent.split(' - ')[0].trim();
    tickerInput.value = tickerText; 
    suggestionsDiv.style.display = 'none'; 
    fetchData(tickerInput.value);
  }
});

rangeButtons.forEach(btn => btn.addEventListener("click", () => {
  rangeButtons.forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  updateChart(+btn.dataset.range);
}));

overlayCheckbox.addEventListener("change", () => { 
  if(overlayCheckbox.checked) {
    fetchOverlayData();
  } else {
    overlayData = [];
    overlaySymbol = "";
    updateChart(+document.querySelector(".range-btn.active").dataset.range); 
  }
});

function formatVolume(v) {
  if(v >= 1e9) return (v/1e9).toFixed(2) + "B";
  if(v >= 1e6) return (v/1e6).toFixed(1) + "M";
  if(v >= 1e3) return (v/1e3).toFixed(1) + "K";
  return v;
}

async function fetchWithFinnhub(symbol) {
  log("Fetching " + symbol + " from Finnhub...");
  const api = APIs.finnhub;
  const to = Math.floor(Date.now() / 1000);
  const from = to - (365 * 24 * 3600);
  
  const url = "https://finnhub.io/api/v1/stock/candle?symbol=" + symbol + "&resolution=D&from=" + from + "&to=" + to + "&token=" + api.key;
  log("URL: " + url.replace(api.key, 'KEY_HIDDEN'));
  
  const resp = await fetch(url);
  const json = await resp.json();
  log("Response status: " + json.s, {sampleData: json.t ? json.t.slice(0, 3) : null});
  
  if(json.s !== "ok" || !json.t || json.t.length === 0) {
    throw new Error("No data from Finnhub");
  }
  
  return json.t.map((t, i) => ({
    date: new Date(t * 1000),
    close: json.c[i],
    open: json.o[i],
    volume: json.v[i],
    high: json.h[i],
    low: json.l[i]
  }));
}

async function fetchWithAlphaVantage(symbol) {
  log("Fetching " + symbol + " from Alpha Vantage...");
  const api = APIs.alphavantage;
  
  const url = "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=" + symbol + "&outputsize=full&apikey=" + api.key;
  log("URL: " + url.replace(api.key, 'KEY_HIDDEN'));
  
  const resp = await fetch(url);
  const json = await resp.json();
  log("Response keys:", Object.keys(json));
  
  const timeSeries = json["Time Series (Daily)"];
  if(!timeSeries) {
    throw new Error("No data from Alpha Vantage: " + (json["Error Message"] || json["Note"] || "Unknown error"));
  }
  
  return Object.entries(timeSeries).map(([date, values]) => ({
    date: new Date(date),
    close: parseFloat(values["4. close"]),
    open: parseFloat(values["1. open"]),
    volume: parseFloat(values["5. volume"]),
    high: parseFloat(values["2. high"]),
    low: parseFloat(values["3. low"])
  })).sort((a, b) => a.date - b.date);
}

async function fetchWithTwelveData(symbol) {
  log("Fetching " + symbol + " from Twelve Data...");
  const api = APIs.twelvedata;
  
  const url = "https://api.twelvedata.com/time_series?symbol=" + symbol + "&interval=1day&outputsize=365&apikey=" + api.key;
  log("URL: " + url.replace(api.key, 'KEY_HIDDEN'));
  
  const resp = await fetch(url);
  const json = await resp.json();
  log("Response status:", json.status);
  
  if(json.status === "error" || !json.values) {
    throw new Error("No data from Twelve Data: " + (json.message || "Unknown error"));
  }
  
  return json.values.map(item => ({
    date: new Date(item.datetime),
    close: parseFloat(item.close),
    open: parseFloat(item.open),
    volume: parseFloat(item.volume),
    high: parseFloat(item.high),
    low: parseFloat(item.low)
  })).reverse();
}

async function fetchData(symbol) {
  try {
    loadingDiv.style.display = 'block';
    const upperSymbol = symbol.toUpperCase();
    stockHeading.textContent = upperSymbol;
    stockName.textContent = stockNames[upperSymbol] || upperSymbol;
    
    // Update chart logo from Simple Icons with a filter for black outline
    chartLogo.src = `https://cdn.simpleicons.org/${upperSymbol.toLowerCase()}`;
    chartLogo.style.display = 'block';
    // CSS filter: invert(1) grayscale(1) brightness(0) invert(1); attempts to make the logo black if it's already a solid color.
    chartLogo.onerror = () => { chartLogo.style.display = 'none'; };
    
    debugLog = [];
    log("=== Starting fetch for " + symbol + " ===");
    
    const selectedAPI = apiSelect.value;
    let fetchedData;
    
    try {
      if(selectedAPI === "finnhub") {
        fetchedData = await fetchWithFinnhub(symbol);
      } else if(selectedAPI === "alphavantage") {
        fetchedData = await fetchWithAlphaVantage(symbol);
      } else if(selectedAPI === "twelvedata") {
        fetchedData = await fetchWithTwelveData(symbol);
      }
    } catch(apiError) {
      log("Primary API failed: " + apiError.message);
      
      const fallbackAPIs = Object.keys(APIs).filter(k => k !== selectedAPI);
      for(const fallback of fallbackAPIs) {
        try {
          log("Trying fallback: " + APIs[fallback].name);
          if(fallback === "finnhub") {
            fetchedData = await fetchWithFinnhub(symbol);
          } else if(fallback === "alphavantage") {
            fetchedData = await fetchWithAlphaVantage(symbol);
          } else if(fallback === "twelvedata") {
            fetchedData = await fetchWithTwelveData(symbol);
          }
          log("Fallback " + APIs[fallback].name + " succeeded!");
          apiSelect.value = fallback;
          apiNote.textContent = "Using " + APIs[fallback].name + " - " + APIs[fallback].note;
          break;
        } catch(fallbackError) {
          log("Fallback " + APIs[fallback].name + " failed: " + fallbackError.message);
        }
      }
    }
    
    if(!fetchedData || fetchedData.length === 0) {
      throw new Error("All APIs failed to return data");
    }
    
    data = fetchedData;
    log("Successfully loaded " + data.length + " data points");
    
    const latest = data[data.length - 1];
    stockInfo.close.textContent = "Close: $" + latest.close.toFixed(2);
    stockInfo.open.textContent = "Open: $" + latest.open.toFixed(2);
    stockInfo.volume.textContent = "Volume: " + formatVolume(latest.volume);
    
    if(data.length >= 2) {
      const latest = data[data.length - 1];
      const previous = data[data.length - 2];
      const change = latest.close - previous.close;
      
      trendArrow.style.display = 'inline-flex';
      if(change > 0) {
        arrowIcon.textContent = '▲';
      } else if(change < 0) {
        arrowIcon.textContent = '▼';
      } else {
        arrowIcon.textContent = '•';
      }
    }
    
    loadingDiv.style.display = 'none';
    updateChart(+document.querySelector(".range-btn.active").dataset.range);
    
  } catch(err) {
    loadingDiv.style.display = 'none';
    log("FATAL ERROR: " + err.message);
    alert("Error: " + err.message + "\n\nCheck the debug log for details. Try:\n1. Different API provider\n2. Different ticker (IBM works with Alpha Vantage demo)\n3. Wait a minute if rate limited");
    console.error(err);
  }
}

async function fetchOverlayData() {
  const symbol = prompt("Enter second ticker:");
  if(!symbol) {
    overlayCheckbox.checked = false;
    return;
  }
  
  try {
    loadingDiv.style.display = 'block';
    overlaySymbol = symbol.toUpperCase();
    log("=== Fetching overlay: " + overlaySymbol + " ===");
    
    const selectedAPI = apiSelect.value;
    let fetchedData;
    
    if(selectedAPI === "finnhub") {
      fetchedData = await fetchWithFinnhub(overlaySymbol);
    } else if(selectedAPI === "alphavantage") {
      fetchedData = await fetchWithAlphaVantage(overlaySymbol);
    } else if(selectedAPI === "twelvedata") {
      fetchedData = await fetchWithTwelveData(overlaySymbol);
    }
    
    overlayData = fetchedData;
    log("Overlay loaded: " + overlayData.length + " points");
    
    loadingDiv.style.display = 'none';
    updateChart(+document.querySelector(".range-btn.active").dataset.range);
  } catch(err) {
    loadingDiv.style.display = 'none';
    overlayCheckbox.checked = false;
    log("Overlay error: " + err.message);
    alert("Overlay error: " + err.message);
    console.error(err);
  }
}

function updateChart(days) {
  if(!data.length) {
    log("No data to chart");
    return;
  }
  
  log("Updating chart with " + days + " days");
  
  const view = data.slice(-days);
  const overlayView = overlayCheckbox.checked && overlayData.length ? overlayData.slice(-days) : [];
  
  if(chart) {
    chart.destroy();
  }
  
  const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
  const labels = view.map(d => monthNames[d.date.getMonth()] + " " + d.date.getFullYear());
  
  const datasets = [{
    label: stockHeading.textContent || "Stock",
    data: view.map(d => d.close),
    borderColor: '#1a2e4b',
    backgroundColor: 'rgba(193, 211, 224, 0.6)',
    borderWidth: 2.5,
    fill: true,
    tension: 0.4,
    pointRadius: 0,
    pointHoverRadius: 5
  }];
  
  if(overlayView.length) {
    datasets.push({
      label: overlaySymbol,
      data: overlayView.map(d => d.close),
      borderColor: '#e07b62',
      backgroundColor: 'transparent',
      borderWidth: 2,
      borderDash: [5, 3],
      fill: false,
      tension: 0.4,
      pointRadius: 0,
      pointHoverRadius: 5
    });
  }
  
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: datasets
    },
    plugins: [{
      id: 'verticalHoverLine',
      afterDatasetsDraw(chart) {
        if(chart.tooltip._active && chart.tooltip._active.length) {
          const activePoint = chart.tooltip._active[0];
          const ctx = chart.ctx;
          const x = activePoint.element.x;
          const topY = chart.scales.y.top;
          const bottomY = chart.scales.y.bottom;
          
          ctx.save();
          ctx.beginPath();
          ctx.moveTo(x, topY);
          ctx.lineTo(x, bottomY);
          ctx.lineWidth = 1;
          ctx.strokeStyle = '#1a2e4b';
          ctx.setLineDash([5, 5]);
          ctx.stroke();
          ctx.restore();
        }
      }
    }],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          display: overlayView.length > 0,
          position: 'top',
          labels: {
            font: {
              family: "'League Spartan', sans-serif",
              size: 14
            }
          }
        }
,
        tooltip: {
          enabled: true,
          backgroundColor: '#fff',
          titleColor: '#333',
          bodyColor: '#333',
          borderColor: '#1a2e4b',
          borderWidth: 1,
          padding: 10,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label;
            },
            label: function(context) {
              const label = context.dataset.label || '';
              const value = context.parsed.y;
              const dataIndex = context.dataIndex;
              
              if(context.datasetIndex === 0 && view[dataIndex]) {
                const vol = formatVolume(view[dataIndex].volume);
                const open = view[dataIndex].open;
                const close = view[dataIndex].close;
                return [
                  label + ": $" + value.toFixed(2),
                  "Open: $" + open.toFixed(2),
                  "Close: $" + close.toFixed(2),
                  "Volume: " + vol
                ];
              }
              return label + ": $" + value.toFixed(2);
            }
          }
        }
      },
      scales: {
        x: {
          display: true,
          grid: {
            display: false
          },
          ticks: {
            maxTicksLimit: 8,
            font: {
              family: "'League Spartan', sans-serif"
            }
          }
        },
        y: {
          display: true,
          grid: {
            color: 'rgba(0,0,0,0.05)'
          },
          ticks: {
            callback: function(value) {
              return '$' + value.toFixed(2);
            },
            font: {
              family: "'League Spartan', sans-serif"
            }
          }
        }
      },
      animation: {
        duration: 2000,
        easing: 'easeInOutQuart',
        delay: (context) => {
          let delay = 0;
          if (context.type === 'data' && context.mode === 'default') {
            delay = context.dataIndex * 3;
          }
          return delay;
        }
      }
    }
  });
  
  log("Chart rendered with " + view.length + " points");
}

log("=== Dashboard Initialized ===");
fetchData("AAPL");
</script>
</body>
</html>