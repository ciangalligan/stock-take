<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Take Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --main-bg:#FFF1E0;--chart-bg:#FFF1E0;
  --line1:#1a2e4b;--line2:#e07b62;
  --area-color:#c1d3e0;--font-color:#333;
  --btn-bg:#e0e0e0;
}
body{font-family:'League Spartan',sans-serif;background:var(--main-bg);margin:0;padding:20px;display:flex;flex-direction:column;align-items:center;}
h1{font-weight:600;margin:0;color:var(--font-color);text-align:center;}
h2{font-style:italic;font-weight:400;font-size:0.9rem;color:var(--font-color);margin:10px 0 40px;text-align:center;}
section{width:95%;max-width:1600px;background:var(--chart-bg);border-radius:10px;padding:20px;margin-bottom:30px;display:flex;flex-direction:column;align-items:center;}
#stock-heading{font-size:1.5rem;font-weight:600;margin-bottom:10px;}
#input-area{margin:15px 0;width:320px;position:relative;}
input[type=text]{padding:8px 12px;font-size:16px;border:1px solid #ccc;border-radius:5px;width:100%;}
#suggestions{position:absolute;background:#fff;width:100%;border:1px solid #ccc;max-height:250px;overflow-y:auto;z-index:10;display:none;}
#suggestions div{padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:5px;}
#suggestions div:hover{background-color:var(--area-color);}
#stock-info{display:flex;gap:15px;margin:15px 0;justify-content:center;flex-wrap:wrap;}
.stock-item{background:var(--btn-bg);padding:10px 15px;border-radius:6px;border:1px solid #ccc;}
#range-buttons{margin:15px 0;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.range-btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;background:var(--btn-bg);color:var(--font-color);font-weight:600;}
.range-btn.active{background:var(--line1);color:#fff;}
#chart{width:60%;height:600px;background:var(--chart-bg);position:relative;}
.loading{color:var(--line1);font-weight:600;margin:20px 0;}
canvas{display:block;width:100%;height:100%;}
.trend-arrow{font-size:2rem;margin:15px 0;display:flex;align-items:center;justify-content:center;gap:10px;}
.trend-arrow .arrow{font-weight:300;transition:transform 0.3s ease;}
.trend-up{color:#2d7a3e;}
.trend-down{color:#c94a3a;}
#debug{margin-top:20px;padding:15px;background:#f5f5f5;border-radius:6px;max-width:800px;font-size:12px;font-family:monospace;white-space:pre-wrap;max-height:200px;overflow-y:auto;display:none;}
.api-note{font-size:0.85rem;color:#666;margin-top:10px;text-align:center;font-style:italic;}
.api-selector{margin:10px 0;}
.api-selector select{padding:6px 12px;border-radius:4px;border:1px solid #ccc;font-family:'League Spartan',sans-serif;}
</style>
</head>
<body>

<h1>Stock Take</h1>
<h2>Finance Through Data</h2>

<section id="stocks-section">
  <div id="stock-heading">AAPL</div>
  
  <div class="api-selector">
    <label>API Provider: 
      <select id="api-select">
        <option value="finnhub">Finnhub (Free)</option>
        <option value="alphavantage">Alpha Vantage (Demo)</option>
        <option value="twelvedata">Twelve Data (Free)</option>
      </select>
    </label>
    <button id="debug-toggle" style="margin-left:10px;padding:6px 12px;border-radius:4px;border:1px solid #ccc;cursor:pointer;">Show Debug</button>
  </div>
  
  <div id="input-area">
    <input type="text" id="ticker" placeholder="Search ticker (e.g. AAPL)">
    <div id="suggestions"></div>
  </div>
  
  <div style="margin-bottom:10px;">
    <label><input type="checkbox" id="overlay-ticker"> Overlay Second Ticker</label>
  </div>
  
  <div id="stock-info">
    <div class="stock-item" id="info-close">Close: -</div>
    <div class="stock-item" id="info-open">Open: -</div>
    <div class="stock-item" id="info-volume">Volume: -</div>
  </div>
  
  <div class="trend-arrow" id="trend-arrow" style="display:none;">
    <span class="arrow" id="arrow-icon"></span>
  </div>
  
  <div id="range-buttons">
    <button class="range-btn" data-range="30">1M</button>
    <button class="range-btn" data-range="90">3M</button>
    <button class="range-btn active" data-range="180">6M</button>
    <button class="range-btn" data-range="365">1Y</button>
  </div>
  
  <div id="loading" class="loading" style="display:none;">Loading data...</div>
  <div class="api-note" id="api-note">Using Finnhub API</div>
  <div id="chart">
    <canvas id="chartCanvas"></canvas>
  </div>
  
  <div id="debug"></div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
const tickerInput = document.getElementById("ticker");
const suggestionsDiv = document.getElementById("suggestions");
const overlayCheckbox = document.getElementById("overlay-ticker");
const stockHeading = document.getElementById("stock-heading");
const loadingDiv = document.getElementById("loading");
const debugDiv = document.getElementById("debug");
const debugToggle = document.getElementById("debug-toggle");
const apiSelect = document.getElementById("api-select");
const apiNote = document.getElementById("api-note");
const trendArrow = document.getElementById("trend-arrow");
const arrowIcon = document.getElementById("arrow-icon");

const stockInfo = {
  close: document.getElementById("info-close"),
  open: document.getElementById("info-open"),
  volume: document.getElementById("info-volume")
};
const rangeButtons = document.querySelectorAll(".range-btn");
const canvas = document.getElementById("chartCanvas");
const ctx = canvas.getContext("2d");

let data = [];
let overlayData = [];
let overlaySymbol = "";
let chart = null;
let debugLog = [];

const APIs = {
  finnhub: {
    name: "Finnhub",
    key: "ct7bu69r01qioqnedut0ct7bu69r01qioqneduug",
    note: "Free tier - 60 calls/minute"
  },
  alphavantage: {
    name: "Alpha Vantage",
    key: "demo",
    note: "Demo key - works for IBM, limited calls"
  },
  twelvedata: {
    name: "Twelve Data",
    key: "demo",
    note: "Demo key - 8 calls/day"
  }
};

const tickersList = ["AAPL","MSFT","TSLA","GOOGL","AMZN","SPY","NFLX","NVDA","META","IBM","QQQ","DIA","BA","WMT","V","JPM","JNJ","PG","KO","DIS"];

function log(msg, data) {
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = "[" + timestamp + "] " + msg;
  debugLog.push(logEntry);
  if(data) debugLog.push(JSON.stringify(data, null, 2));
  debugDiv.textContent = debugLog.slice(-20).join('\n');
  console.log(msg, data);
}

debugToggle.addEventListener("click", () => {
  if(debugDiv.style.display === "none") {
    debugDiv.style.display = "block";
    debugToggle.textContent = "Hide Debug";
  } else {
    debugDiv.style.display = "none";
    debugToggle.textContent = "Show Debug";
  }
});

apiSelect.addEventListener("change", () => {
  const api = APIs[apiSelect.value];
  apiNote.textContent = "Using " + api.name + " - " + api.note;
  log("Switched to " + api.name + " API");
});

tickerInput.addEventListener("input", () => {
  const val = tickerInput.value.trim().toUpperCase();
  const filtered = tickersList.filter(t => t.startsWith(val));
  suggestionsDiv.innerHTML = filtered.map(t => "<div>" + t + "</div>").join("");
  suggestionsDiv.style.display = filtered.length ? "block" : "none";
});

suggestionsDiv.addEventListener("click", (e) => {
  const div = e.target.closest("div");
  if(div) {
    tickerInput.value = div.textContent.trim(); 
    suggestionsDiv.style.display = 'none'; 
    fetchData(tickerInput.value);
  }
});

rangeButtons.forEach(btn => btn.addEventListener("click", () => {
  rangeButtons.forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  updateChart(+btn.dataset.range);
}));

overlayCheckbox.addEventListener("change", () => { 
  if(overlayCheckbox.checked) {
    fetchOverlayData();
  } else {
    overlayData = [];
    overlaySymbol = "";
    updateChart(+document.querySelector(".range-btn.active").dataset.range); 
  }
});

function formatVolume(v) {
  if(v >= 1e9) return (v/1e9).toFixed(2) + "B";
  if(v >= 1e6) return (v/1e6).toFixed(1) + "M";
  if(v >= 1e3) return (v/1e3).toFixed(1) + "K";
  return v;
}

async function fetchWithFinnhub(symbol) {
  log("Fetching " + symbol + " from Finnhub...");
  const api = APIs.finnhub;
  const to = Math.floor(Date.now() / 1000);
  const from = to - (365 * 24 * 3600);
  
  const url = "https://finnhub.io/api/v1/stock/candle?symbol=" + symbol + "&resolution=D&from=" + from + "&to=" + to + "&token=" + api.key;
  log("URL: " + url.replace(api.key, 'KEY_HIDDEN'));
  
  const resp = await fetch(url);
  const json = await resp.json();
  log("Response status: " + json.s, {sampleData: json.t ? json.t.slice(0, 3) : null});
  
  if(json.s !== "ok" || !json.t || json.t.length === 0) {
    throw new Error("No data from Finnhub");
  }
  
  return json.t.map((t, i) => ({
    date: new Date(t * 1000),
    close: json.c[i],
    open: json.o[i],
    volume: json.v[i],
    high: json.h[i],
    low: json.l[i]
  }));
}

async function fetchWithAlphaVantage(symbol) {
  log("Fetching " + symbol + " from Alpha Vantage...");
  const api = APIs.alphavantage;
  
  const url = "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=" + symbol + "&outputsize=full&apikey=" + api.key;
  log("URL: " + url.replace(api.key, 'KEY_HIDDEN'));
  
  const resp = await fetch(url);
  const json = await resp.json();
  log("Response keys:", Object.keys(json));
  
  const timeSeries = json["Time Series (Daily)"];
  if(!timeSeries) {
    throw new Error("No data from Alpha Vantage: " + (json["Error Message"] || json["Note"] || "Unknown error"));
  }
  
  return Object.entries(timeSeries).map(([date, values]) => ({
    date: new Date(date),
    close: parseFloat(values["4. close"]),
    open: parseFloat(values["1. open"]),
    volume: parseFloat(values["5. volume"]),
    high: parseFloat(values["2. high"]),
    low: parseFloat(values["3. low"])
  })).sort((a, b) => a.date - b.date);
}

async function fetchWithTwelveData(symbol) {
  log("Fetching " + symbol + " from Twelve Data...");
  const api = APIs.twelvedata;
  
  const url = "https://api.twelvedata.com/time_series?symbol=" + symbol + "&interval=1day&outputsize=365&apikey=" + api.key;
  log("URL: " + url.replace(api.key, 'KEY_HIDDEN'));
  
  const resp = await fetch(url);
  const json = await resp.json();
  log("Response status:", json.status);
  
  if(json.status === "error" || !json.values) {
    throw new Error("No data from Twelve Data: " + (json.message || "Unknown error"));
  }
  
  return json.values.map(item => ({
    date: new Date(item.datetime),
    close: parseFloat(item.close),
    open: parseFloat(item.open),
    volume: parseFloat(item.volume),
    high: parseFloat(item.high),
    low: parseFloat(item.low)
  })).reverse();
}

async function fetchData(symbol) {
  try {
    loadingDiv.style.display = 'block';
    stockHeading.textContent = symbol.toUpperCase();
    debugLog = [];
    log("=== Starting fetch for " + symbol + " ===");
    
    const selectedAPI = apiSelect.value;
    let fetchedData;
    
    try {
      if(selectedAPI === "finnhub") {
        fetchedData = await fetchWithFinnhub(symbol);
      } else if(selectedAPI === "alphavantage") {
        fetchedData = await fetchWithAlphaVantage(symbol);
      } else if(selectedAPI === "twelvedata") {
        fetchedData = await fetchWithTwelveData(symbol);
      }
    } catch(apiError) {
      log("Primary API failed: " + apiError.message);
      
      const fallbackAPIs = Object.keys(APIs).filter(k => k !== selectedAPI);
      for(const fallback of fallbackAPIs) {
        try {
          log("Trying fallback: " + APIs[fallback].name);
          if(fallback === "finnhub") {
            fetchedData = await fetchWithFinnhub(symbol);
          } else if(fallback === "alphavantage") {
            fetchedData = await fetchWithAlphaVantage(symbol);
          } else if(fallback === "twelvedata") {
            fetchedData = await fetchWithTwelveData(symbol);
          }
          log("Fallback " + APIs[fallback].name + " succeeded!");
          apiSelect.value = fallback;
          apiNote.textContent = "Using " + APIs[fallback].name + " - " + APIs[fallback].note;
          break;
        } catch(fallbackError) {
          log("Fallback " + APIs[fallback].name + " failed: " + fallbackError.message);
        }
      }
    }
    
    if(!fetchedData || fetchedData.length === 0) {
      throw new Error("All APIs failed to return data");
    }
    
    data = fetchedData;
    log("Successfully loaded " + data.length + " data points");
    
    const latest = data[data.length - 1];
    stockInfo.close.textContent = "Close: $" + latest.close.toFixed(2);
    stockInfo.open.textContent = "Open: $" + latest.open.toFixed(2);
    stockInfo.volume.textContent = "Volume: " + formatVolume(latest.volume);
    
    if(data.length >= 3) {
      const last3 = data.slice(-3);
      const avgChange = (last3[2].close - last3[0].close) / last3[0].close;
      
      trendArrow.style.display = 'flex';
      if(avgChange > 0) {
        arrowIcon.textContent = '↑';
        arrowIcon.className = 'arrow trend-up';
      } else {
        arrowIcon.textContent = '↓';
        arrowIcon.className = 'arrow trend-down';
      }
    }
    
    loadingDiv.style.display = 'none';
    updateChart(+document.querySelector(".range-btn.active").dataset.range);
    
  } catch(err) {
    loadingDiv.style.display = 'none';
    log("FATAL ERROR: " + err.message);
    alert("Error: " + err.message + "\n\nCheck the debug log for details. Try:\n1. Different API provider\n2. Different ticker (IBM works with Alpha Vantage demo)\n3. Wait a minute if rate limited");
    console.error(err);
  }
}

async function fetchOverlayData() {
  const symbol = prompt("Enter second ticker:");
  if(!symbol) {
    overlayCheckbox.checked = false;
    return;
  }
  
  try {
    loadingDiv.style.display = 'block';
    overlaySymbol = symbol.toUpperCase();
    log("=== Fetching overlay: " + overlaySymbol + " ===");
    
    const selectedAPI = apiSelect.value;
    let fetchedData;
    
    if(selectedAPI === "finnhub") {
      fetchedData = await fetchWithFinnhub(overlaySymbol);
    } else if(selectedAPI === "alphavantage") {
      fetchedData = await fetchWithAlphaVantage(overlaySymbol);
    } else if(selectedAPI === "twelvedata") {
      fetchedData = await fetchWithTwelveData(overlaySymbol);
    }
    
    overlayData = fetchedData;
    log("Overlay loaded: " + overlayData.length + " points");
    
    loadingDiv.style.display = 'none';
    updateChart(+document.querySelector(".range-btn.active").dataset.range);
  } catch(err) {
    loadingDiv.style.display = 'none';
    overlayCheckbox.checked = false;
    log("Overlay error: " + err.message);
    alert("Overlay error: " + err.message);
    console.error(err);
  }
}

function updateChart(days) {
  if(!data.length) {
    log("No data to chart");
    return;
  }
  
  log("Updating chart with " + days + " days");
  
  const view = data.slice(-days);
  const overlayView = overlayCheckbox.checked && overlayData.length ? overlayData.slice(-days) : [];
  
  if(chart) {
    chart.destroy();
  }
  
  const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
  const labels = view.map(d => monthNames[d.date.getMonth()] + " " + d.date.getFullYear());
  
  const datasets = [{
    label: stockHeading.textContent,
    data: view.map(d => d.close),
    borderColor: '#1a2e4b',
    backgroundColor: 'rgba(193, 211, 224, 0.6)',
    borderWidth: 2.5,
    fill: true,
    tension: 0.4,
    pointRadius: 0,
    pointHoverRadius: 5
  }];
  
  if(overlayView.length) {
    datasets.push({
      label: overlaySymbol,
      data: overlayView.map(d => d.close),
      borderColor: '#e07b62',
      backgroundColor: 'transparent',
      borderWidth: 2,
      borderDash: [5, 3],
      fill: false,
      tension: 0.4,
      pointRadius: 0,
      pointHoverRadius: 5
    });
  }
  
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: datasets
    },
    plugins: [{
      id: 'verticalHoverLine',
      afterDatasetsDraw(chart) {
        if(chart.tooltip._active && chart.tooltip._active.length) {
          const activePoint = chart.tooltip._active[0];
          const ctx = chart.ctx;
          const x = activePoint.element.x;
          const topY = chart.scales.y.top;
          const bottomY = chart.scales.y.bottom;
          
          ctx.save();
          ctx.beginPath();
          ctx.moveTo(x, topY);
          ctx.lineTo(x, bottomY);
          ctx.lineWidth = 1;
          ctx.strokeStyle = '#1a2e4b';
          ctx.setLineDash([5, 5]);
          ctx.stroke();
          ctx.restore();
        }
      }
    }],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          display: overlayView.length > 0,
          position: 'top',
          labels: {
            font: {
              family: "'League Spartan', sans-serif",
              size: 14
            }
          }
        },
        tooltip: {
          enabled: true,
          backgroundColor: '#fff',
          titleColor: '#333',
          bodyColor: '#333',
          borderColor: '#1a2e4b',
          borderWidth: 1,
          padding: 10,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label;
            },
            label: function(context) {
              const label = context.dataset.label || '';
              const value = context.parsed.y;
              const dataIndex = context.dataIndex;
              
              if(context.datasetIndex === 0 && view[dataIndex]) {
                const vol = formatVolume(view[dataIndex].volume);
                return [
                  label + ": $" + value.toFixed(2),
                  "Volume: " + vol
                ];
              }
              return label + ": $" + value.toFixed(2);
            }
          }
        }
      },
      scales: {
        x: {
          display: true,
          grid: {
            display: false
          },
          ticks: {
            maxTicksLimit: 8,
            font: {
              family: "'League Spartan', sans-serif"
            }
          }
        },
        y: {
          display: true,
          grid: {
            color: 'rgba(0,0,0,0.05)'
          },
          ticks: {
            callback: function(value) {
              return '$' + value.toFixed(2);
            },
            font: {
              family: "'League Spartan', sans-serif"
            }
          }
        }
      },
      animation: {
        duration: 2000,
        easing: 'easeInOutQuart',
        delay: (context) => {
          let delay = 0;
          if (context.type === 'data' && context.mode === 'default') {
            delay = context.dataIndex * 3;
          }
          return delay;
        }
      }
    }
  });
  
  log("Chart rendered with " + view.length + " points");
}

log("=== Dashboard Initialized ===");
fetchData("AAPL");
</script>
</body>
</html>